---
title: "Assignment 03"
author: "Regression Diagnostics"
date: "Answer Key"
header-includes:
   - \usepackage{xcolor}
   - \definecolor{umn}{HTML}{FF2D21}
   - \usepackage{caption}
   - \captionsetup[table]{textfont={it}, labelfont={bf}, singlelinecheck=false, labelsep=newline}
   - \captionsetup[figure]{textfont={it}, labelfont={bf}, singlelinecheck=false, labelsep=newline}
   - \usepackage{floatrow}
   - \floatsetup[figure]{capposition=top}
   - \usepackage{xfrac}
output: 
  pdf_document:
    highlight: tango
    latex_engine: xelatex
    fig_width: 6
    fig_height: 6
mainfont: "Sabon"
sansfont: "Helvetica Neue UltraLight"
monofont: "Inconsolata"
urlcolor: "umn"
always_allow_html: yes
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE)

library(broom)
library(car)
library(ggplot2)
library(gridExtra)
library(dplyr)

stack = readr::read_csv("~/Dropbox/My Mac (CEHD-m1752583)/Documents/github/epsy-8264/data/stack-1979.csv")
```

This assignment is worth 18pts.


## Exploratory Analysis

**1. Start by creating scatterplots to examine the relationship between each of the predictors and the outcome. Are there observations that look problematic in these plots? If so, identify the country(ies).**

```{r, message=FALSE, fig.height=4, fig.width=12, out.width='6in', fig.align='center'}
#scatterplotMatrix(stack[-1], smooth = FALSE)[1, ]
p1 = ggplot(data = stack, aes(x = socialist, y = inequality)) +
  geom_text(aes(label = country), size = 3) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_bw()

p2 = ggplot(data = stack, aes(x = energy, y = inequality)) +
  geom_text(aes(label = country), size = 3) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_bw()

p3 = ggplot(data = stack, aes(x = turnout, y = inequality)) +
  geom_text(aes(label = country), size = 3) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_bw()

grid.arrange(p1, p2, p3, nrow = 1)
```

Based on these plots, South Africa seems to have an exceptionally large residual in several of the plots.

\vspace{3em}

**2. Fit the regression model specified earlier to the data. Report the fitted equation.**

```{r}
lm.1 = lm(inequality ~ 1 + turnout + energy, data = stack)
#tidy(lm.1)
```

$$
\hat{\mathrm{Inequality}}_i = 10.311 - 0.081(\mathrm{Voter~Turnout}_i) - 0.0003(\mathrm{Energy}_i)
$$

\newpage

**3. Create and include a set of plots that allow you to examine the assumptions for linear regression. Based on these plots, comment on the tenability of these assumptions.**

```{r fig.height=5, fig.width=10, out.width='5in', fig.align='center', message=FALSE}
par(mfrow = c(1, 2))
residualPlot(lm.1)
qqPlot(lm.1, id = FALSE)
par(mfrow = c(1, 1))
```

Based on the QQ-plot, the assumption of normality seems tenable. The assumption that the conditional mean is zero (linearity) seems generally tenable; although the observation with a fited value near 8 may be problematic. Similarly the homoskedasticity assumption also seems tenable apart from that same observation.

\vspace{3em}

## Outliers, Leverage, and Influence

**4. Compute the studentized residuals for the observations based on the fitted regression. Based on these values, identify any countries that you would consider as regression outliers. Explain why you identified these countries as regression outliers.**

```{r}
my_diagnostics = augment(lm.1) %>%
  mutate(
    country = stack$country,
    row_num = 1:nrow(stack),
    student_resid = rstudent(lm.1),
    abs_student_resid = abs(student_resid),
    dffits = abs(dffits(lm.1)),
    COVRATIO = abs(covratio(lm.1) - 1)
  )

# my_diagnostics %>%
#   arrange(desc(abs_student_resid)) %>%
#   select(country, student_resid, abs_student_resid)
#   head()
```

Argentina ($t_i=-2.54$) and South Africa ($t_i=2.22$) may be regression outliers. Both of these countries have an absolute studentized residual value that suggests their inequality is more than two standard errors from what they would be predicted to have given their predictor values.

\vspace{3em}

**5. Fit a mean-shift model that will allow you to test whether the observation with the largest absolute studentized residual is statistically different from zero. Report the coefficient-level output ($B$, $SE$, $t$, and $p$) for this model.**

```{r}
stack = stack %>%
  mutate(
    d_argentina = if_else(country == "Argentina", 1, 0)
  )

# Mean-shift model
lm_ms = lm(inequality ~ 1 + socialist + turnout + energy + d_argentina, data = stack)
tidy(lm_ms)

```

\newpage

**6. Find (and report) the Bonferroni adjusted $p$-value for the observation with the largest absolute studentized residual. Based on this $p$-value, is there statistical evidence to call this observation a regression outlier? Explain.**

```{r}
outlierTest(lm.1)
```

Based on the Bonferroni-adjusted $p$-value of 0.416, it is likely that Argentina's studentized residual value is not significantly different than zero. The evidence suggests that Argentina is NOT a regression outlier.

\vspace{3em}

**7. Create and include an index plot of the leverage values. Include a line in this plot that displays the cutpoint for "high" leverage. Based on this plot, identify any countries with large leverage values.**

```{r fig.width=6, fig.height=6, out.width='3.5in'}
h_cutpoint = 2 * mean(my_diagnostics$.hat)
# my_diagnostics %>% 
#   filter(.hat >= 2 *h_bar) %>% 
#   arrange(desc(.hat)) %>%
#   select(country, .hat)

ggplot(data = my_diagnostics, aes(x = row_num, y = .hat)) +
  geom_text(aes(label = country), size = 3) +
  geom_hline(yintercept = h_cutpoint, lty = "dashed", color = "red") +
  theme_bw() +
  xlab("Index") +
  ylab("Leverage values")

```

There are two countries that have potentially high leverage values: South Africa, and the United States. These countries were identifed because they have leverage values that are more than twice as large as the mean leverage value.

\vspace{3em}

**8. Based on the evidence you have looked at in Questions \#4--7, do you suspect that any of the countries might influence the regression coefficients? Explain.**

Because South Africa was identified as a potential regression outlier (even though the test was non-significant) and as having high leverage, it may be influential.

\newpage

## Influence Measures

**9. For each of the influence measures listed below, create and include an index plot of the influence measure. For each plot, also include a line that displays the cutpoint for "high" influence. (3pts)**

    **a. Scaled (standardized) DFBETA values**
    **b. Cook's $D$**
    **c. DFFITS**
    **d. COVRATIO**


```{r fig.height=6, fig.width=9, out.width='6in', fig.align='center'}
# DFBETAs
DFBETA = data.frame(
  country = stack$country,
  row_num = 1:nrow(stack)
) %>%
  cbind(dfbetas(lm.1))

names(DFBETA)[3] = "intercept"

d1 = ggplot(data = DFBETA, aes(x = row_num, y = abs(intercept))) +
  geom_text(aes(label = country), size = 3) +
  geom_hline(yintercept = 2/sqrt(18), lty = "dashed", color = "red") +
  theme_bw() +
  xlab("Index") +
  ylab("|Scaled DFBETA|") +
  ggtitle("Intercept DFBETA")

d2 = ggplot(data = DFBETA, aes(x = row_num, y = abs(turnout))) +
  geom_text(aes(label = country), size = 3) +
  geom_hline(yintercept = 2/sqrt(18), lty = "dashed", color = "red") +
  theme_bw() +
  xlab("Index") +
  ylab("|Scaled DFBETA|") +
  ggtitle("Voter Turnout DFBETA")

d3 = ggplot(data = DFBETA, aes(x = row_num, y = abs(energy))) +
  geom_text(aes(label = country), size = 3) +
  geom_hline(yintercept = 2/sqrt(18), lty = "dashed", color = "red") +
  theme_bw() +
  xlab("Index") +
  ylab("|Scaled DFBETA|") +
  ggtitle("Energy Consumption DFBETA")


# Cook's D
d_cutpoint = 4/15

d4 = ggplot(data = my_diagnostics, aes(x = row_num, y = .cooksd)) +
  geom_text(aes(label = country), size = 3) +
  geom_hline(yintercept = d_cutpoint, lty = "dashed", color = "red") +
  theme_bw() +
  xlab("Index") +
  ylab("Cook's D values") +
  ggtitle("Cook's D")


# DFFITS 
dffits_cutoff = 2 * sqrt(3/15)

d5 = ggplot(data = my_diagnostics, aes(x = row_num, y = dffits)) +
  geom_text(aes(label = country), size = 3) +
  theme_bw() +
  geom_hline(yintercept = dffits_cutoff, linetype = "dashed", color = "red") +
  xlab("Index") +
  ylab("|DFFITS|") +
  ggtitle("DFFITS")


# COVRATIO
covratio_cutpoint = 3 * 3 / 18

d6 = ggplot(data = my_diagnostics, aes(x = row_num, y = COVRATIO)) +
  geom_text(aes(label = country), size = 3) +
  theme_bw() +
  geom_hline(yintercept = covratio_cutpoint, linetype = "dashed", color = "red") +
  xlab("Index") +
  ylab("|COVRATIO - 1|") +
  ggtitle("COVRATIO")

# Create final plot
grid.arrange(d1, d2, d3, d4, d5, d6, nrow = 2)
```

\vspace{3em}

**10. Show how the Cook's $D$ value for the country with the largest Cook's $D$ value is calculated using the country's leverage value and studandardized residual.**

```{r}
# my_diagnostics %>%
#   arrange(desc(.cooksd)) %>%
#   select(country, .cooksd, .std.resid, .hat)
```

South Africa has the largest Cook's $D$ value ($D_i = 3.99$). To compute this value:

$$
\begin{split}
D_i &= \frac{{e^{\prime}_i}^2}{k+1} \times \frac{h_{ii}}{1 - h_{ii}} \\[2ex]
&= \frac{1.978^2}{3} \times \frac{0.754}{1 - 0.754} \\[2ex]
&= 3.99
\end{split}
$$

\vspace{3em}

**11. Create and include the added-variable plots for each each of the coefficients. Based on these plots, identify any countries that you believe may be jointly influencing the regression coefficients.**

```{r fig.height=3, fig.width=9, out.width='5in', fig.align='center'}
avPlots(lm.1, intercept = TRUE, layout = c(1, 3))
```

Based on these plots, Observation 1 (Argentina) and 17 (United States) may jointly influence the regression coefficients. Observations 5 (France) and 13 (South Africa) were also identified, but given these plots do not look that problematic.

\vspace{3em}


## Remove and Refit

**12. Based on all of the evidence from the different influence measures you examined, identify and report the country(ies) that are influential. Explain how you decided on this set of observations.**

*Answers will vary*

Based on the evidence, there are three observations I identified as influential: Argentina, the United States, and South Africa. All three of these were identified as influential in the different index plots and also were identified in the added-variable plots. 

**13. Remove the observations you identified in Question \#13 from the data and refit the regression model omitting these observations. Report the fitted equation.**

```{r}
stack_2 = stack %>% filter(!country %in% c("Argentina", "South Africa", "United States"))

lm.2 = lm(inequality ~ 1 + turnout + energy, data = stack_2)
#tidy(lm.2)
```


$$
\hat{\mathrm{Inequality}}_i = 9.24 - 0.071(\mathrm{Voter~Turnout}_i) - 0.0001(\mathrm{Energy}_i)
$$

\newpage

**14. Create and include a set of plots that allow you to examine the assumptions for linear regression. Based on these plots, comment on the tenability of these assumptions.**

```{r fig.height=5, fig.width=10, out.width='5in', fig.align='center', message=FALSE}
par(mfrow = c(1, 2))
residualPlot(lm.2)
qqPlot(lm.2, id = FALSE)
par(mfrow = c(1, 1))
```

Based on the QQ-plot, the assumption of normality seems tenable. The assumption that the conditional mean is zero (linearity) and homoskedasticity assumptions also look tenable after removing the three influential observations.

\vspace{3em}

**15. Compare and contrast the coefficient-level inferences from the model fitted with the full data and that fitted with the omitted observations.**

```{r}
reduced = tidy(lm.2)

x = tidy(lm.1) %>% 
  select(term, p.value) %>%
  mutate(
    estimate_red = reduced$p.value
    )

knitr::kable(x, digits=2, col.names = c("Term", "Full Data", "Reduced Data"), caption = "Comparison of p-Values")

```

The $p$-values for the energy consumption effect has become non-significant once the three influential observations were removed. 

\vspace{3em}

**16. Compare the model-level summaries, namely $R^2$ and the RMSE, from the model fitted with the full data and that fitted with the omitted observations.**

```{r}
x2 = glance(lm.1) %>%
  rbind(
    glance(lm.2)
  ) %>%
  mutate(model = c("Full Data", "Reduced Data")) %>%
  select(model, r.squared, sigma)

knitr::kable(x2, digits=2, col.names = c("", "$R^2$", "RMSE"), caption = "Comparison of p-Values")
```

The $R^2$ value and RMSE both diminished once the three influential countries were removed. 




